3	GPON时间同步标准和原理

3.1	GPON时间同步标准简介
IEEE1588v2标准是针对以太接口实现时间同步的协议标准，报文封装和识别等定义都不适合PON接口实现，而且ITU-T标准未定义针对PON封装的时间同步标准；但PON原理实现需要进行高精度测距补偿，所以为支持PON接口实现时间同步传递，专门定义了PON时间同步的标准。
在标准G.984.3 amd 2新增了时间同步协议说明，并给出OMCI报文格式，用来携带OLT的精确发送时间，让ONT可以通过本地接收时间和报文携带的。
但是当前标准未定义Announce报文传送规范，需要继续优化补充。

3.2	GPON时间同步原理
在GPON设备接口对接时，已经通过GPON标准定义的测距方法完成线路延时测量，所以在GPON系统实现时间同步利用测量的延时进行补偿，实现原理简单；
3.2.1	GPON时间同步原理
具体时间同步计算方法和模型见下面的分析。

其中各个时戳点的说明：
Tstamp为下行第N帧零均衡时延，零响应时间点
Tsend为下行第N帧发送时间
Trecv为ONU收到下行第N帧的时间
RspTime为ONU响应时间，范围是34-36us
Teqd为零距离的等效延时
n1310为1310nm波长的折射率
n1490为1490nm波长的折射率


3.2.2	OMCI报文格式
标准定义的OMCI set操作报文格式如下，消息内容携带TOD信息，用来传递时间同步信息。
当前标准定义了时间同步信息传送的报文格式，但是时间信息对应的质量等级信息却无法传递，所以当前标准需要定义Announce报文传送规范，优化时间同步标准内容，以便下游设备来确定PON下发的源是否是可用的源。我司设备采用私有报文格式把OLT选源产生的同步质量信息通过PON下发给ONU设备，ONU设备再生announce报文分发给下游基站设备。


3.2.3	PON网络同步模型
在应用时，OLT设备上行接口作为1588V2标准的Slave接口，实现时间和频率跟踪上游设备，或者通过外时间口注入1pps+TOD信息实现时间跟踪基准源，然后OLT通过下行PON接口和ONU实现时间同步，ONU再作为1588V2标准的Marster接口提供时间同步信息给下游的Slave设备或无线基站，或者通过外时间接口输出1pps＋TOD信息给下游设备或无线基站。
基本原理模型如下图：


根据上图的模型，可应用支撑接入网络时间同步的场景，具体见接入1588v2典型应用场景分析部分。
接入设备中OLT、ONU作为一个整体，OLT、ONU之间的连接看作是一个设备的内部链接，只在NNI、UNI接口实现1588v2协议的处理，对进出IP报文进行时戳处理，接入设备内部则通过PON实现时间同步传递。
在OLT设备NNI接入到上游时间同步传送网元时，OLT作为1588v2的Slave端口实现时钟和时间同步上游Master设备，或者OLT通过外时间接口注入时钟时间信息，然后实现时钟时间同步，然后通过PON向ONU传送时钟时间同步信息。

 在实现PON时间同步的时候，首先需要通过PON线路实现ONU时钟跟踪OLT时钟，达到时钟同步，然后再通过时间同步标准步骤实现时间同步，时钟的同步是时间同步的基础；
在ONU设备上通过PON接口实现时间同步，，然后ONU的UNI接口作为1588v2的Master端口或者ONU输出1pps＋ToD外时间进行时间信息的分发，从而实现时间同步分配。


4	1pps+ToD接口
4.1	1pps+ToD接口介绍
外时间接口为设备提供了另外一种时间同步的方式。在不占用业务资源的基础上，利用设备已实现的时钟同步，加上外时间接口就可以实现设备间的时间同步。外时间类型有两种类型：DCLS、1PPS+TOD（TOD支持NMEA或UBX数据格式），本文主要介绍后一种接口。
1）1PPS 
1PPS是一种用于时间定标的秒脉冲信号，采用RS422信号电平。脉冲频率为1Hz，即每秒一个脉冲。1PPS信号脉冲宽带为100ns～400ms，脉冲上升沿UTC时间严格对齐。
2）TOD 
TOD是一种采用ASCII码表示的时间信息编码格式。TOD信号采用RS232或RS422信号电平，波特率为9600bit/s。TOD传送的内容包括：当前日期/时间、时间标准ID、1PPS有效状态指示、UTC闰秒调整日期/时间、闰秒调整指令、GPS时间信息等。
TOD时间信息支持UBX格式和NMEA格式。
NMEA格式：是为了在不同的GPS导航设备中建立统一的BTCM（海事无线电技术委员会）标准，由美国国家海洋电子协会（NMEA-The National Marine Electronics Association）制定的一套通讯协议。该协议采用ASCII码，格式中有起始结束特征字符，以“，”作为域间隔符。
UBX格式：Ublox公司的私有格式，采用二进制编码（在中国移动使用UBX协议），没有固定的“起始和结束”特征字符，靠长度域来识别。

4.2	1PPS+TOD接口要求
1PPS+TOD协议，采用类似GPS星卡时间接口的方案，需要传送两种信号，采用双线来传送秒帧头和时间信息；1PPS+TOD时间信号是将1PPS（One Pulse Per Second）脉冲信号和TOD（Time of Day）时间信息组合起来发送的一种时间信号。 

1）1PPS
信号电平：3.3V TTL或RS422；
信号脉宽： 100ns~450ms，上升沿采样，表示绝对时刻（上升时间应小于50ns）。
2）TOD时间信息
信号电平：     RS232电平或RS422电平；
波特率：       9600比特每秒；
奇偶校验：     无；
数据比特：     8位（比特）；
起始位：       1位（比特，低电平表示）
停止位：       1位（比特，高电平表示）；
消息有效位置： 消息在1PPS上升沿开始后1ms后开始传送TOD信息，500毫秒内发完；
空闲帧：       高电平。
此TOD消息标示当前1PPS上升沿时间，TOD协议报文发送频率为每秒1次。
3）物理接头RJ45线序要求如表5，在差分模式时需要2根信号来实现输出或输入，此表信号排序为差分方式线序，单端RS232信号无此线序要求。
表5  外时间接口1pps＋ToD信号排序

5.2	接入时间同步典型应用场景
接入设备通过PON进行时间同步传送，只能单向从OLT传到ONU，所以时间注入只能在OLT设备，反向则不能传同步；可以从承载网注入时间源，通过1588v2接口传送时间给接入OLT设备作为接入设备时间源，也可以直接从接入OLT设备注入把时间源，下面主要说明这两种源注入应用的场景。
5.2.1	 OLT注入1588v2时间同步
BITS作为OC设备向汇聚层承载设备注入时间源，承载汇聚层设备作为BC设备，逐跳恢复时间，接入设备OLT作为OC或BC设备（根据上行端口的数量确定），通过1588v2标准实现时间同步上游网元，ONU作为OC设备，通过PON实现时间恢复传递，基站作为OC设备，从接入ONU设备上获取时间信息，可以用外时间1pps＋ToD接口，或者用1588v2接口。
接入1588v2同步方式的优势在于OLT设备和ONU设备间采用单纤双向的PON接口，收发光纤天然对称，降低了1588v2实现时间同步要求收发对称的工程实施难度，方便部署。同时，OLT作为OC或BC节点运行BMC算法，能够实现很好的BITS参考源和跟踪路径的自动保护倒换。ONU和OLT间可通过各种保护组网实现时间同步可靠传送。PON接口announce报文信息传递，需要通过PLOAM传递OLT选源后产生的announce报文给ONU，ONU再发送到基站，然后基站设备进行源选择判断。
ONU可以是单端口支持1588v2或多端口支持1588v2，所以上图OC仅说明ONU不跟踪1588V2作为Slave端口，而只能作为Master端口；

5.2.2	OLT注入1pps+ToD时间同步
时间透传场景中，时间源从接入设备注入，OLT跟踪1pps＋Tod时间，同步到BITS上。
OLT和ONU通过PON接口实现时间传递，ONU时间同步到OLT后，再用外时间接口输出1pps＋ToD给基站，或者用1588v2接口输出给基站，实现时间同步分配。
从应用上看，从OLT注入时间信息，因为PON的单纤双向测距，保证了收发线路对称，减少了工程应用测距补偿工作，但是因为BITS下移到接入层，需要布放更多的BITS和GPS。


6	1588v2部署考虑
对于时钟/时间源，设备类型可以看成是增加了GPS卫星时间同步和1588V2功能的BITS，注入点一般选择放置在RNC侧或骨干层，若网络规模较大，也可以放在汇聚层。一张1588v2同步网络一般配置一主一备两个时钟/时间源设备，不同时钟/时间源通过配置不同的优先级实现备份。
对于承载设备，一般采用分层结构，可分为骨干层、汇聚层和接入层，按照不同网络规模三个层次可以合并，如某些场景，骨干层和汇聚层融合。承载网的网络拓扑一般分为环形、树形、链形、星形等，由于同步网络需要实现网络保护，建议采用环形网络，末端可以采用链形组网。
接入设备一般部署在网络末端，所以一般采用星型组网，根据接入客户的可靠等级要求，进行PON设备的保护组网，OLT和上游承载设备是否需要网络保护，根据网络设计要求进行规划。
从时间源设备BITS到承载网到基站，1588v2时间同步链路上的网元一般不超过30个网元。
6.2	物理拓扑对同步精度的影响
理论上PTP协议在任何分组网络环境中都能够运行。在现实网络中，通常存在不支持PTP的网桥或者路由器，这些设备通常会引起较大的延时和延时抖动，导致PTP Slave设备无法实现预期的高同步精度。为了提升同步性能，可使用1588 BC或者TC设备替代不支持PTP同步的路由器和普通网桥。这就是说为了获得满足要求的高时间同步精度，建议网络逐跳支持1588V2。
6.3	准确度问题
协议栈延迟波动
1、PTP的最简单实现是在网络协议栈顶作为普通应用运行。时间戳是成于应用层，协议栈延迟波动导致这些时间戳中的错误。这些错误典型为100us到ms范围。
2、可以在中断层级而非应用层级生成时间戳。此时延迟波动通常能够减少到10us级，具体取决于其它应用对中断的具体使用，和网络上业务流量的情况。
3、通过硬件辅助技术可以获得最小的协议栈延迟波动，该技术在协议栈物理层生成时间戳，这就是1588协议中建议的在PHY和MAC之间，通过硬件电路来给1588报文打戳。此时延迟波动典型为ns范围。误差来源于从输入数据流中恢复时钟和数据同步的PHY芯片所属相位锁定特征导致。
网络转发延时波动
1、网络组件在消息的传播过程中引入波动，将直接影响路径延时和Offset。业务转发的延时抖动可通过在物理层硬件打戳来规避。而承载信号传输的物理链路，如光纤、电缆等的延时抖动，无法通过硬件打戳来规避。
2、如果一定要穿越不支持1588的网桥或者路由器等，高优先级业务转发延时波动较小，支持流量优先级的网桥和路由器，可以设置发送的PTP事件消息相对其它数据而言更高的优先级。但一般说来，即使采用最高优先级转发，也很难精确控制报文的转发延时波动，不适合大规模部署。
时间戳准确度
PTP要求时间戳的时钟分辨率必须和理想的准确度保持一致。对于TC和从时钟节点，本地时钟频率往往和GM存在差异，也将影响时间戳的精度。因此，频率同步是时间同步的基础，必须在频率同步良好的情况下，才能获得好的时间同步性能。
PON测距准确度
OLT和ONU之间的测距和同步精度。GPON上行测距单位是bit time（约为0.8ns），测距精度约8～24bit time；所以PON的测距精度影响最终时间同步的精度（约正负20ns）。

6.4	系统实现问题
为了确保构建的PTP系统是最佳的，网络部署时建议考虑：
1，整个域内所有PTP节点使用相同的底层传送协议，如PTP over Ethernet，PTP over UDP over IPV4；
2，整个域内选择相同的BMC算法；
3，整个域内使用相同的状态配置选项；
4，整个域内使用相同的通道延迟测量机制，如全部为E2E，或者全部为P2P；
5，整个系统中所有节点的属性和可配置数据集成员使用相同的默认值；
6，整个系统中所有节点的属性使用相同的最大和最小范围数值；
7，整个域内使用相同PTP模板；
8，整个域内使用相同的标准版本；
9，接入设备PON接口需要都支持相同版本的时间同步标准；
6.5	性能考虑
满足下列要求可以获得最佳时钟同步性能：
1，主从之间的链路延迟应是对称的。如果时间戳机制或链路包含不对称延迟，并且是不可忽略的，应该正确进行补偿；而对于接入设备OLT的上行接口和ONU设备的下行接口需要考虑主从的链路延迟不对称，而OLT和ONU之间的PON因为是单纤双向模式，所以不需要考虑不对称延迟问题；
2，主从节点之间的网络延迟在一个Sync、Delay_Req消息发送的时间间隔内应该是恒定的；
3，PTP中使用的时间戳应尽可能靠近物理层；
4，实现协议的设备计算能力必须足够大，且时钟数量必须合适，以此满足定时约束。例如因资源限制而无法处理这些消息可能导致同步性能的恶化；
5，设备采用晶振的固有稳定度和精确度必须满足G.813或G.8262标准要求；
6，网络规划时充分考虑网络规模，具体网络规划标准还待研究，这里从测试和应用给出建议仅供参考，在仅需要时间同步时同步链路规模需要小于30个节点，在需要时钟和时间都同步时网络同步链路规模需要小于20个节点。接入设备作为最后1跳，OLT和ONU间采用PON接口传送时间，采用星型组网，减少同步链路节点数。

6.6	光纤不对称的工程考虑
从前面1588V2时间同步原理可以看出，1588V2时间同步是建立在Master和Slave之间的收发链路延时对称的基础上的，如果Master和Slave之间的收发链路延时存在不对称，将引入同步误差，误差的大小为链路延时不对称的二分之一。我们可以计算光纤的传输延时，介质的折射率等于光在真空中的速度c跟光在介质中的传播速度v之比：
n ＝ c/v，其中真空中光速为c=299,792,458米/秒，n代表光纤折射率，不是一个确定的值，和光纤型号有关，一般采用安捷伦OTDR测试仪中给出的推荐值1.458，那么：
v＝c/n＝299,792,458/1.458=205618969m/s
1米光纤的延时1/v＝4.86e-9s/m＝4.86ns/m。
也就是说1米光纤的传输延时是5ns，那么1米的不对称将引入2.5ns的时间同步误差，400米的不对称将引入1us的时间同步误差。在实际网络中，很难精确控制全网端到端的光纤不对称在400米以内，而且对于TD-SCDMA、LTE-TDD等+/-1.5us的同步需求来讲，1us的同步误差显然是不能容忍的。因此在1588V2时间同步网工程部署中必须严肃考虑网络的光纤不对称问题。  
业界目前主要有3种光纤不对称解决方案：
仪表逐点测量：在开局和维护过程中，采用1588仪表逐点测量设备的1588时间同步精度，根据测量到的时间同步精度反推出光纤不对称，然后进行补偿；也可以采用OTDR仪表直接测量每一对光纤的不对称，然后进行补偿。由于OTDR仪表测量要断业务，且不能直接看到1588同步的结果，因此一般倾向直接采用1588V2仪表进行测量。
单纤双向：设备直接采用单纤双向光模块，收发都在同一根物理光纤上传输，从根本上彻底解决双纤收发链路延时的不对称，不需要进行测量和补偿。单纤双向方案中，由于收发波长不同引起的双向链路延时不对称一般比较小，且可以由设备自动计算和补偿。根据G.652的定义，可以计算出FE单纤双向引入的时间误差约为每公里 1.06ns，GE单纤双向引入的时间误差约为每公里0.544ns，远远小于普通双纤1米2.5ns的时间误差。采用单纤双向光模块后，无论是开局还是维护，都不用下站测量。接入OLT和ONU间通过PON接口实现的时间传递，因为PON天然采用单纤双向模块，实现PON测距，所以在时间同步应用时可不考虑不对称问题，根据PON的测距进行波长误差的补偿即可保证高精度，所以应用时有优势。
环网自动测量：采用普通双纤光模块，开局时通过仪表逐点测量完成光纤不对称补偿。在维护阶段，对于环形组网，则可以通过环网自动测量来避免断纤时重新下站测量，减少断纤维护的工程量。其基本原理是利用1588V2的BMC功能，环网断纤后，会自动倒换到备用路径，环上各节点的时间同步精度仍然维持在可用的范围内；此时如果断纤处的光纤重新接上，设备可以先自动计算和上报新光纤的不对称，然后在网管上根据计算结果进行补偿，之后再倒换回之前的主用路径。
1588V2在电信领域是一个全新的特性，且需要硬件支持，主要用于TD-SCDMA、LTE-TDD等时分复用的3G和LTE系统，在网络部署中应当通过扩容和新建网络逐渐开通，尽量避免在老网上全网改造。随着ITU-T对1588V2时间同步技术的深入研究以及ITU-T G.827x系列标准逐渐成熟和正式发布，电信网络支持1588V2的能力将越来越完善，逐渐成为和SDH、同步以太并驾齐躯的设备必备功能。

