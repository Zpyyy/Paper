交换机中优先级虚拟输出队列调度策略的研究与实现 高杰 2018
(3)对调度策略模型进行精确仿真实现
    将调度策略转发成具体的算法，再将算法解析成OPNET进程模型的状态机，
在OPNET软件中根据不同策略实现对应的仿真模型和数据分析模型，对每种策
略的性能做出精确细致的比较和评价。

    有线网络流量QoS策略研究 牛妍华 2019
QoS标准主要由IETF「( The Internet Engineering Task Force，国际互联网工程任务组)制定，主要包括集成服务模型和差分服模型两类。集成服务模型架构由RFC 1633[3]提出，以RSVP ( Resource Reservation Protocol，资源预留协议)为基础进行服务保障，该模型要求数据流传输链路上的所有节点按要求进行资源预留，因此在网络节点多样性的情况下实现难度较大。差分服务模型由RFC 2475[4]提出，该模型允许不同节点执行不同操作，对关键类型的流打上特定标记并执行不同的PHB ( Per Hop Behavior，逐跳行为)。集成服务和差分服务虽然在理念上是相对的，但是在实际使用中由于业务特征的多样性可以结合使用，集成服务更适用于带宽资源紧缺的网络，差分服务更具灵活性。随着业务发展QoS应用的需求会持续变化，因此QoS标准和模型也会随之变化。
QoS的实现主要由分类和标记、限速和整形、拥塞控制和调度等工具实现。流量入站后首先进行流量识别，确定分类并对数据包进行标记。在传输过程中根据既定策略对网络资源进行分配，如果流量超过可用资源，则进行限速、整形或降级处理。此时流量进入队列等待网络资源可用时再进行传输。DSCP(差分服务代码点)定义了三种类型的PHB . BE ( Best Effort，尽力而为),AF ( Assured Forwarding，确认转发)和EF ( ExpeditedForwarding，快速转发)，此外，CS(Class Selector，类选择器)与IP优先级相对应也用于QoS标记。
IETF制定了一系列针对不同流量特征的分类识别和行为处理的标准，对于不同业务的分类如表1所示[[6]


交换机中优先级虚拟输出队列调度策略的研究与实现 高杰 2018

随着行业的发展和网络流量的复杂化，计算机网络对与交换机提出更高的要
求，需要交换机提供支持流量优先级转发的功能，同时要保证做到低时延、高速
率、无阻塞。现有的基于VoQ技术实现的交换机由于其队列缓存结构特性会出
现以下三个问题:
1)进行优先级转发时出现队头阻塞问题
    VoQ交换机由于每个输入和每个输出端口之间只设置了一个虚拟输出队列，
且采用先进先出工作方式。由于在输出队列中会出现高优先级数据包被低优先级
数据包阻塞的问题，所以这种传统的VoQ结构不支持区分业务优先级的转发模
式，本课题旨在设计一种新型VoQ交换机虚拟输出队列构建方式，解决这一问
题。
2)现有调度算法不支持优先级转发
    传统基于VoQ技术的交换机中的crossbar调度算法没有对业务的优先级做
出区分，如LQF算法、RR算法以及iSLIP算法。认为所有业务的优先级都是平
等的，内部也只是按照先进先出的工作方式公平地进行帧转发。而随着计算机网
络的逐步发展，传统的调度策略己经不能够满足某些行业(如航空航天业)对高速
数据传输、复杂网络计算、通信业务优先级区分、对不同优先级的通信业务采取不同调度策略的复杂要求。
(3)缓存受限问题。
    交换机片内存储空间有限，但是随着交换机端口数量规模增加，需要设置的
VoQ队列数量会越多，每个队列分配到的缓存就会越小，这样每个VoQ队列能
够存储的数据包数量就会越小。为了满足交换机中数据包存储的需求，需要设计
一种新型的数据包存储方式，来节省片内存储空间。


ONU芯片的缓存和通常的缓存概念不同，通常缓存指的是当某一硬件要读取数据时，会首先从缓存中查找需要的数据，如果找到了则直接执行，找不到的话再从内存中找，显然缓存中的数据查找速度比内存中要快得多，这是一个处于CPU内部的一块内存地址空间[33]。而在ONU芯片上，缓存就是数据交换的缓冲区，有时又叫做包缓冲区大小，是一种队列结构，被ONU用来协调不同网络流量之间的速度匹配问题。突发数据可以存储在缓冲区内，直到被调度器处理为止。
虽然缓存对于ONU的转发性能十分重要，以现有的芯片集成技术可以将缓存尽可能地做大。缓存理论上可以通过芯片制作工艺设计放大，但是过大的缓存会影响正常通信状态下数据包的转发速度，因为过大的缓冲空间需要相对多一点的寻址时间，并增加设备的成本[33]，在一些对延迟要求比较高的应用场景中，缓存过大反而会起反作用，所以不能简单地去扩大缓存，要在缓存和延迟两个方面做取舍[33]。当然，随着技术的进步，在尽量不增加延迟的情况下，也可以不断提升ONU芯片的缓存能力。受制于时钟、总线带宽的能力，缓存性能难以大幅提升，考虑到功耗、成本的平衡，缓存容量也不会大幅增加。由于ONU芯片内部缓存容量有限，所以对于队列缓存有限是对于调度策略的一项重要需求。





    在本课题中由于本课题所涉及交换机处理器片内缓存资源有限，无法满足数据包全包排队的需求，故不能将数据包直接存入位于片内的缓存队列。但是在调度数据包时至只需要获取数据包头部的部分信息，如端口号、优先级等，而不需要数据包的具体消息体信息。



缓存资源管理是QoS研究中的热点问题，己经受到了全球各国学者的关注，并且也取得了诸多成果。王垚主要对ICN缓存部署策略和缓存替换策略进行了重点研究和分析，考虑了缓存节点的状态、缓存存储的位置对整体缓存性能优化的影响，提出了基于缓存节点位置和状态的部署策略和动态LRU-K缓存替换策略， 
本文主要通过靴论与排队论结合，对网络QoS进行研究。靴方法与排队论结合的实质是从排队系统中找到靴随机过程，或者通过变换、构造获得新的靴过程，然后利用靴的良好性质，去分析排队系统。
目前，鞅理论在研究网络的QoS应用中，国内外研究并不多。成果最为显著的当属F. Ciucu, F. Poloczek团队，他们发表了一系列基于鞅论的通信研究成果[46-52]创新性地提出了鞅包络、到达鞅和服务鞅的概念，利用指数超鞅结构对业务的累计到达过程、服务过程进行建模，从一个全新的视角建模分析了队列缓存以及时延QoS性能界。下面，我们对该团队的文献进行一下介绍。
文献[46-47]中，F. Ciucu率先应用超鞅方法分析了排队系统的队列缓存溢出概率界和时延违反概率界。文献[46]指出网络演算在计算端到端队列缓存概率界时，常依赖于布尔不等式，结果可能并不紧致。研究中通过超鞅的构造，引入了基于超鞅的Doob不等式，计算了新的队列缓存概率界。对于D/M输入的网络，在低负载率情况下，使用超鞅方法获得的端到端缓存界更为紧致。文献[47]借助了网络微积分中的结果，得出了基于超鞅方法的新的时延概率界。针对M/M/ 1和M/D/1系统，当负载率接近1时，用超鞅方法分析的时延概率界比网络微积分方法更加紧致。文献[48-49]中，F. Ciucu，F. Poloczek再次对网络演算得出的概率界结果提出质疑，指出针对突发到达时，尤其是LVPVI00 (Markov Modulated On O均到达，概率界非常松弛。作者采用超鞅方法推导的新的概率界，可以紧上几个数量级。靴方法得出的概率界同样适用多流的复用，甚至对于非常少的流复用，结果也非常准确。
文献61中，G. Luan利用鞅方法分析了数据中心网络的缓存行为。研究中将网络中的数据到达与离去过程分解分析，在奇数时间单元缓存中数据传输，在偶数时间单元数据到达。构造了两个不同形式的鞅，分别是含有数据到达和离去过程期望的鞅，及关于到达和服务过程的距母函数形式的鞅，利用停时定理，得出了在数据中心网络中队列首次溢出概率与缓存停时期望，为缓存设计提供了指导。
孙洪亮博士针对流量分布不同的业务聚合到达的排队系统,本文引入鞅方法,提出队列缓存行为特性的瞬时分析方法,同一模型中,得出了系统的时间域、概率域二维特征。研究中,通过集成多个到达过程与服务过程到鞅过程中,构造了关于队长的鞅;根据到达过程与服务过程的高阶特性,构造了另一个鞅,通过建立期望不等式,使其也与队长相关。运用鞅停时定理,求解了队列首次溢出概率、缓存停时期望。模型根据瞬时观测的队长,既可以在概率域上预测出队列演化的趋势,又可以得出目标事件出现的时间期望。仿真分析展现了缓存行为的瞬时特性和时间概率二维特性。研究基于鞅理论,提供了多业务到达的队列缓存QoS特性分析的新视角,为系统缓存设计、缓存管理提供了指导。




基于区分服务网络的QoS队列算法研究 宋建伟 2014

 
    各个队列算法的性能特性如表4-1所示。综上所示，FIFO算法过于简单，不体现队列的优先级，不适合区分服务网络;PQ算法公平性较差，对服务的区分过于简单，因此也不适合区分服务网络;基于时间戳的W FQ算法，公平性较高，具有良好的性能，但是算法复杂太高，硬件实现复杂，不利于扩展，也不适合区分服务的网络;基于轮询机制算法实现简单，且支持不同业务的优先级，时间复杂性低、扩展性较高，该算法适合于高速网络中，是区分服务模型首选的调度方案，因此本文重点研究基于轮询的队列调度算法。
总的来说，队列调度算法考虑的信息越多，算法就越有效，复杂度也就越高
未来的网络有两个发展大趋势:带宽高速化和业务多样化。队列调度算法要符合
这些趋势，不仅要保证调度速度较快，还要保证对各种业务的区分和对资源的公
平分配。基于轮询的调度算法具有实现简单并且易于扩展的特定，比较适合于高
速网络，也能满足多样化的业务需求，是适合区分服务调度算法的有效方案。
    作为一种基于轮询的算法，WRR是适合于区分服务的算法。针对WRR算法因分组长度不同而引发的公平性问题，本章提出了IFWRR(Improved Fairness WRR)算法。算法主要针对WRR算法的缺点进行了如下改进，根据各个队列的权值和各个队列中平均数据包的大小，按照实际带宽需求重新计算队列轮询权值，平均队列长度的数据包越大，则新的权值越小。该算法首先解决了WRR算法对变长分组不支持的缺点，重新计算的队列轮询权值参考了分组的长度大小，根据网络带宽的实际需求情况，改善了各个队列因为分组长度不同带来的不公平性;不仅保证了EF业务的服务质量，也保证了低优先级BE业务不会出现“饿死”的现象。

5.2 技术路线
（1）WRR改进算法
    IFWRR算法根据各个物理队列的预约带宽进行基于轮询的队列调度，能够根据权值大小进行对业务流的区分服务，因此符合算法第一个目标，也达到队列调度算法的有效性的指标。同时算法只是在WRR调度之前增加了测量和权值计算的功能，并不会增加调度系统的复杂度，因此IFWRR算法是实现简单并可扩展的。
    下面中在各个队列之间的公平性进行分析。当各个物理队列不为空的情况下，
算法要能够确保各个物理队列的最小带宽。
    
    公式(4-2)为WRR算法中，各个物理队列占用的带宽情况，其中w.为各个队
列的权值，C为链路带宽，因此可以看出各个物理队列分配到的实际带宽与队列
的权值之间成正相关的关系，但是带宽分配并未考虑分组的大小。

（2）层次化QoS的实现
当要对多个出端口的流量进行统一限速后再转发到个端口的时候，就需要通过至少两级调度来实现。所有的流量首先全部进入第一级调度器，完成统一限速整形后，报文再根据各自携带的目的端口入指定出端口的队里。其逻辑框图如下：

为了简化实现，芯片设计上将这两级调度通过一个“环回端口”统一成了一级调度，称之为“二次入队”：
为了提供用户级的QoS，需要层次化的调度拓扑，EQM采用二次入队的方法来实现这个功能。PE编辑后的报文进入EQM的队列，如果二次入队指示有效，则经过拥塞管理、调度然后从PORT0端口调度出队后进入EPS，EPS读取二次入队所需要的队列信息后再环回到EQM的入端口，再重新经过拥塞管理、调度发往真正的出端口。
在上行映射表或者OFC中，可以指定报文是否进入预调度端口以及进入编号为多少的预调度端口。逻辑根据这个指示给出的预调度端口索引结合OPP里面的二次入队队列映射表将报文送入指定的队列（该队列最终连接到环回端口），报文经过一次调度以后从环回端口返回并再次入队，进行正常的端口调度。
（3）零拷贝方案的实现
 

  零拷贝就是一种避免 CPU 将数据从一块存储拷贝到另外一块存储的技术。利用该技术可以减少数据拷贝和共享总线操作的次数，消除传输数据在存储器之间不必要的中间拷贝次数，从而有效地提高数据传输效率。而且，零拷贝技术减少了用户应用程序地址空间和操作系统内核地址空间之间因为上下文切换而带来的开销。进行大量的数据拷贝操作其实是一件简单的任务，从操作系统的角度来说，如果 CPU 一直被占用着去执行这项简单的任务，那么这将会是很浪费资源的；如果有其他比较简单的系统部件可以代劳这件事情，从而使得 CPU 解脱出来可以做别的事情，那么系统资源的利用则会更加有效。
如图所示为某实验单板的布局图，WiFi报文经WiFi AP通过PCIE2总线与ONT芯片连接，原数据传输流程为：
WIFI报文经过WiFI AP写入片外缓存共享DDR，再经过PCIE总线传输进ONT芯片，在芯片内部入口调度模块，将WiFi 报文从DDR中WOE的存储区，拷贝至DDR中DP模块的存储区，DDR再释放WOE存储区的缓存，

零拷贝方案中，WIFI报文经过WiFI AP写入片外缓存共享DDR后，仅将携带报文信息的报文头传入ONT芯片，因而后续操作减少了一次DDR缓存的读写过程，与此同时，由于只有120Bytes的报文进入转发模块，减少了片内缓存的资源占用，提升转发性能。后续在出队调度模块将DDR中WOE存储区的报文身体与报文头进行拼接，完成了wifi报文的转发调度。

零拷贝报文由于报文头存储在DP的内置缓存或者外置缓存中，报文身体存储在WOE的外置缓存中；报文头的管理按照原来DP的缓存管理方式进行管理；
零拷贝报文身体的管理方式基于CELL方式进行管理，CELL大小可配置为2KB/4KB，该CELL大小不是实际的外置缓存CELL大小，而是换算单位；
零拷贝报文身体的队列资源管理方式和DP的缓存队列资源管理方式相同，即总体资源配置+队列独享+队列尾丢+队列组尾丢+队列组芯片尾丢+芯片尾丢+拥塞丢弃+WRED丢弃的管理方式；
零拷贝报文身体的各级资源配置按照DP中队列资源配置的ncopy_total_mode和ncopy_queue_mode系数进行配置；
队列独享，队列尾丢，队列拥塞，wred；队列组最大共享，队列组共享拥塞 用 ncopy_queue_mode的系数；
队列组芯片尾丢，芯片拥塞，芯片最大共享，芯片最大值，芯片的最大使用中断上报 用的 ncopy_total_mode的系数； 
两个系数可选范围集为{1/8、2/8、3/8、4/8、5/8、6/8、7/8、8/8、9/8、10/8、11/8、12/8、13/8、14/8、15/8、2}；
零拷贝报文头和报文身体任何一套管理判决丢弃，则包应该丢弃；
