1	范围

2	特性功能简介
时间同步系统是时钟同步系统和时间同步系统的融合。
时钟同步系统主要完成与上级时间源的频率同步和实现系统内部各模块的时钟同步。时钟同步系统包括物理层同步和1588v2报文同步两种方案，其中物理层同步支持：时钟管脚时钟同步、同步以太时钟同步和XPON线路时钟同步。
时间同步系统主要完成与时间源和下级设备的时间同步。时间同步方案支持：DCSL时间同步、1PPS+TOD时间同步、XPON线路时间同步、1588v2时间同步。
2.1	时钟同步
2.1.1	时钟管脚时钟同步
时钟管脚时钟同步是指主时钟源通过管脚将时钟输出给目的时钟。
2.1.2	同步以太时钟同步
同步以太和传统SDH同步类似，是一种基于物理层码流携带和恢复频率信息的同步技术。同步以太技术从以太网线路的串行码流里提取时钟，通过选源算法后，送给设备系统时钟锁相环跟踪产生系统时钟，然后通过系统时钟把该端口的线路时钟作为其他同步以太端口的发送参考时钟，在发送的串行码流重发送出去。
接收方向，从线路串行码流中提取时钟要求码流中必须保持足够的时钟跳变信息，也就是避免连续的长1或者长0。以太网物理层编码采用4B/5B（FE）和8B/10B（GE），平均每4个BIT就要插入一个附加比特，这样就不会出现连续4个1或者4个0，从而加便于提取时钟。
在发送方向，同样需要对发送的串行码流按照编码规则进行加扰，以避免接收侧无法提取时钟。
IEEE 802.3标准定义了各种类型的以太网接口，并非所有的接口都支持同步以太，如自协商模式下，如果PHY的某一个端口被协商成Slave模式，那么该端口只能提取接收侧的线路时钟，但发送侧不能跟踪系统时钟，而是直接采用接收侧提取的线路环回作为发送时钟。此时我们说该端口不支持全功能的同步以太，只能支持单方向的同步以太。ITU-T G.8262标准在附录中详细说明了IEEE802.3的各种以太接口对同步以太的支持能力，详见下
2.1.3	XPON线路时钟同步
XPON线路时钟同步指使用XPON SerDes的恢复的线路时钟作为设备的源时钟。
XPON线路时钟同步只适用于终端设备（ONT/MXU）。
2.1.4	1588v2时钟同步
1588v2时钟同步通过交换Sync报文产生的时间戳来实现。
1588v2时钟同步的原理详见：附件一《IEEE Standard for a Precision Clock Synchronization Protocol for Networked Measurement and Control Systems》标准“12. Synchronization and syntonization of clocks”章节。
下面是摘自附件二《IEEE 1588v2特性设计规范（v1.0）》中“3.4.1 1588v2频率同步原理”章节有关1588v2时钟同步的描述：
假设时钟A要同步到时钟B，不考虑路径延时和报文驻留时间的变化，如果A和B的时钟频率相等，则在相同的时间间隔内，A和B的时间累积的偏差应该是一样的，也就是说t2N-t20=t1N-t10。如果t2N-t20大于t1N-t10，说明A的时钟频率比B快，要调慢A的时钟频率；如果t2N-t20小于t1N-t10，说明A的时钟频率比B慢，则要调快A的时钟频率。
4	芯片实现分析
4.1	时钟同步
不同芯片时钟同步方案差异较大，需要针对芯片进行具体分析，但OLT芯片和ONT芯片时钟同步基本遵循如下原则：
1）OLT芯片用作接入板时，在接入板会通过外部晶振跟踪主控板输出的8K时钟。
2）OLT芯片用作上行板时，会采用同步以太的方式从ETH端口恢复时钟，并使用外部晶振跟踪恢复出来的时钟，使整个OLT系统跟随该时钟。
3）ONT芯片PON上行时，会从PON线路中恢复时钟，并使用内置或外置的晶振跟踪恢复出来的时钟，使整个芯片跟随该时钟。
4）ONT芯片ETH上行时，会采用同步以太的方式从ETH线路中恢复时钟，并使用内置或外置的晶振跟踪恢复出来的时钟，使整个芯片跟随该时钟
4.2.1.5	接收方向时间戳的处理
接收方向在接收到1588v2报文时接口逻辑会产生80bit时间戳，MAC将该时间戳转换为32bit时间戳，并采用带内传输的方式将32bit时间戳传递给芯片后续模块进行处理。带内传输方式是指在报文最后添加上4个字节，用于携带32bit时间戳。
为了防止以太报文在传输时出错，在以太报文最后会携带上4个字节的FCS字段用于差错检测。接口逻辑在接收到以太报文时对FCS字段有两种处理方式：1）自行检测FCS后剥离FCS字段后再将报文传递给下一模块；2）不剥离FCS字段，将报文的FCS直接传递给后续模块，由后续模块进行检测。
4.2.1.6	发送方向时间戳的处理
发送方向NP会在1588v2报文前添加8个字节，用于指示接口逻辑在报文发送时进行时间戳的处理。
4.3.3.1.1	Opcode：操作码
Opcode主要用于指示接口逻辑进行不同的处理。
1、各Opcode对应的处理如下
3'b000： 对报文中的时间戳不做任何处理。
3'b001： 在报文中携带报文的发送时间戳。
在报文发送时接口逻辑产生80bit时间戳，将80bit时间戳填充到1588v2报文的OriginTimestamp域。
3'b010： 非对称延时补偿。
由于传输路径的不对称，会导致接收和发送方向路径延迟不一致，因此需要在发送方向进行非对称延时补偿。
使用1588v2协议无法进行非对称延时的测量，所以需要通过其它手段进行非对称延时的测量并提供给1588v2协议，芯片在实现时由软件通过配置1个位宽为24bit的寄存器将非对称延时提供给1588v2协议，该寄存器bit23为符号位（1'b0表示负，1'b1表示正），延时补偿的范围为±8ms。
接口逻辑在非对称延时补偿时会将非对称延时加到1588v2报文的CorrectionField域中。
3'b011： 报文时间戳刷新。
CorrectionField = 报文中的CorrectionField + 报文发送时产生的47/48bit时戳（支持47bit或48bit两种时间戳模式可配）。
3'b100： 记录当前报文的发送时间戳
记录当前报文的80bit时戳和47/48bit时戳，用于刷新下一个配对的Follow_Up报文的时间戳。
3'b101： Follow_Up报文携带时间戳
使用上一个Opcode为3'b100且Sequence ID与当前Follow_Up一致的报文的80bit时间戳刷新Follow_Up报文的OriginTimestamp域。
3'b110： 报文时间戳刷新及非对称延时补偿
CorrectionField = 报文中的CorrectionField + 报文发送时产生的47/48bit时戳（支持47bit或48bit两种时间戳模式可配）± 非对称延时。
3'b111： Follow_Up报文时间戳刷新
Follow_Up报文的CorrectionField域 = Follow_Up报文的CorrectionField域+ 上一个Opcode为3'b100且Sequence ID与当前Follow_Up一致的报文的47/48bit时戳 （支持47bit或48bit两种时间戳模式可配）。


测试过程中以OLT主控板为时钟源，被测设备与OLT主控板之间使用8K管脚传递时钟信息，使用DCLS管脚传递时间信息。上图中的测试设备主要用于测试被测设备的DCLS输出功能，若有多个1PPS（DCLS）输出，需要在每个输出上都接一个测试设备。
测试时将OLT主控板、被测设备和测试设备的1PPS测试管脚与测试仪表连接，用于观察三者的时间同步情况。
