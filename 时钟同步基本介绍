 	网络IP化引发分组网络时钟同步问题
	IP化是未来网络和业务的发展趋势，但是以SDH为基础的传统网络过渡到以IP为基础的分组传送网络目前还存在很多困难，一个关键技术是解决新网络对传统TDM业务的承载。传统TDM有两个主要的应用，语音业务和时钟同步业务。对于语音，VoIP化后，在IP网络上承载的技术已经成熟并且大规模应用，但是对于时钟同步业务相关的各种技术还在发展中,于是分组时钟技术开始崭露头角。
 	业界提出了几种实现分组网络(PSN)同步的技术方案
	TOP（Timing Over Packet-switching network）
	以太网物理层同步
	IEEE1588V1/ IEEE 1588V2
	NTP


 	什么是1588？
	IEEE 1588是网络测量和控制系统的精密时钟同步协议标准，采用PTP（精密时钟同步）协议，精度可以达到微秒级。此标准的目的是为了精确地把测量与控制系统中分散、独立运行的时钟同步起来。
 	1588有何优势？
同步技术	频率同步	时间同步	相关标准
TOP	√	×	ITU-T G.8261
以太网物理层同步	√	×	ITU-T G.8262
1588	√	√	IEEE 1588v2
NTP	√	√	RFC 1305 



 	【术语解释】 什么是同步 ?  指两个或两个以上信号之间，在频率或相位上保持某种特定关系，即两个或两个以上信号在相对应的有效瞬间，其相位差或频率差保持在约定的允许范围之内，由同步的定义可知，同步包括以下两种：频率同步和时间同步（相位同步）。目前的3G协议如TD-SCDMA等对于时间同步都有明确的要求。
 	其它同步技术有何特点和优势？
同步技术	技术特点	优势	局限
TOP	•	将本地时钟（timing）信息根据一定的封装格式放入数据包（packet）中发送，在接收端从包中恢复时钟，通过算法和封装格式尽量规避PSN传送过程中所带来的损伤	•	支持PSN网络透传，不要求中间设备支持TOP，运用灵活
•	厂商芯片支持较好，我司也有相关技术开发，实现技术较成熟	•	恢复时钟的质量依赖于承载的PSN网络，受网络延迟抖动、丢包、错序的影响非常大，需要保证业务高QoS
•	 没有标准化协议，不同设备间兼容性差
•	 不支持时间同步
以太网物理层同步	•	利用以太网物理层同步技术，最后达到包网络的全面同步	•	时钟同步质量接近SDH
•	不受PSN网络影响
•	系统时钟架构与SDH方案相似，实现技术较成熟	•	需要全网部署
•	不是所有的以太接口都可以恢复时钟
•	不支持时间同步
NTP	•	NTP（网络时间协议），时钟定时方式类似与1588，广泛用于Internet网络定时	•	可以同时实现频率与时间同步	•	时钟精度为ms级，不能满足3G电信网络的要求
1588v2	•	PTP（精确时钟同步协议），利用协议报文传递同步信息，可应用于电信、测量和工业控制领域的同步	•	可以实现时间同步
•	时钟精度为亚us级，应用范围广
•	协议自动协商、无需配置	•	要求全网设备支持，必须全网部署
•	新技术，要求硬件支持，协议较复杂，部署成本较高

 	IEEE1588的前世今生
	以太网在1985年成为IEEE802.3标准后，在1995年将数据传输速度从10Mb/s提高到100Mb/s的过程中，计算机和网络业界也在致力于解决以太网的定时同步能力不足的问题，开发出一种软件方式的网络时间协议（NTP），提高各网络设备之间的定时同步能力，但是仍然不能满足测量仪器和工业控制所需的准确度 ；
	为解决上述问题，2000年底成立网络精密时钟同步委员会，2001年中获得IEEE仪器和测量委员会美国标准技术研究所（NIST）的支持，该委员会起草的规范在2002年底获得IEEE标准委员会通过作为IEEE1588标准；
	在通讯领域中，PSN网络传时钟的技术迅速发展，IEEE组织对1588进行了重新修订，最新版本在2006.6月份输出，2007年完成V2修订。
 	IEEE1588 V2的新增特性
	亚us级的准确度；
	更快的同步（SYNC）信息速率 ；
	更短的PTP信息，单播信息，新的信息(路径延迟需求/响应/相应follow-up)和信息字段；
	引入透明时钟（TC）可以用来防止级联拓扑中的误差累计；
	故障容限，它用来保证不会因为某单一网络单元失效引起对端时钟也故障 ；
	TLV扩展用来延伸协议特性和功能；
	将1588映射到其他传输机制。
 	时间同步(Synchronization):
	相同的频率
 	时钟2与时钟1的频率相同
	相同的相位
 	时钟2与时钟1的相位相同
	相同的时间(time of day)
 	时间跟踪至一个公共的、统一的时标，如UTC、TAI等


 	时钟同步(Syntonization)：
	相同的频率
 	时钟2与时钟1的频率相同
	不同的相位
 	时钟2与时钟1的相位可能不同
	不同的时间(time of day)
 	时间可能不同 
标准时间源 
第一个时间源是实现NTP协议的一套广泛运用于校园和全世界的计算机系统。这些NTP服务器自身同步到国际标准时间服务器。从NTP系统获得的UTC时间精度通常在毫秒范围。NTP提供当前时间、当前闰秒数(仅在NTP版本4支持)，以及标识引入闰秒修正的告警标志。NTP系统的时间起点为1900年1月1日0时。
第二个系统是由美国国防部维护的全球卫星定位系统(GPS)。从GPS系统获取到的时间精度在10～100纳秒范围内。GPS系统传输时间的形式为{GPS星期数，最近一周的GPS秒数}，也就是从GPS起点开始的周数以及从当前周开始的秒数。GPS提供当前时间，当前闰秒数目，以及引入闰秒校修正的告警标志。GPS系统的时间起点为1980年1月6日0时。

 	PTP时标起点
	起点是一个域的时标的起点。
	PTP起点是TAI时间的1970年1月1日0时0分0秒，UTC时间的1969年12月31日23时59分51.999918秒
	PTP支持两种类型的时标：
	PTP时标：在正常运行情况中，起点是PTP时标起点，并且时标是连续的。时间度量单位是SI秒。
	独立时标：正常运行情况下起点通过管理进程设置。在正常运行期间允许复位起点。在两个管理进程的调用之间，时标是连续的。额外的调用管理进程的干预可能引起整个时标不连续。

 	共有五种基本的PTP设备类型：
	OC(Ordinary clock)：仅有一个物理接口同网络通信，既可作为Grandmaster Clock，也可作为Slave Clock。 
	BC(Boundary clock)：有多个物理接口同网络通信，每个物理端口行为都类似于Ordinary Clock的端口，可连接多个子域。 
	E2E TC(End-to-end transparent clock)：E2E TC设备有多个接口，它转发所有PTP消息，并测量PTP事件消息经过该设备的驻留时间，并进行修正。 
	P2P TC(Peer-to-peer transparent clock)：P2P TC设备有多个接口，与E2E TC设备相比，它还可以测量该设备每个端口相连链路的延迟 ，并进行修正。
	PTP管理设备：该设备具有多个接口，提供PTP管理消息的管理接口















 	同步过程概述：
	主从层次确定：通过“BMC算法”和“PTP端口状态机”确定OC和BC设备每个端口的主从状态，划分同步网络的主从层次。
     说明：TC设备不参与层次的确定
	时钟信息同步：在PTP系统中，OC或BC时钟设备同步通过在它们之间的物理链路上交换PTP消息，计算出主从时间偏移和链路延时，完成同步。

 

 	主从层次确定：
	根据OC和BC设备上端口所处的状态，可以对MESH网络进行裁剪，确定主从层次，消除PTP网络的环回：


































时钟信息同步：
	主从时钟时间的同步：Master记录SYNC消息记录出发时刻T1；Slave记录SYNC消息达时刻T2；路径延时为td。那么主从时钟之间的时间偏差为：
	offsetFromMaster ＝ T2－td－T1
	从时钟向前调整offsetFromMaster就实现主从时钟之间的同步。
	主从时钟频率信息的同步：Master记录第1个SYNC的发送时刻为T11，第N个SYNC的发送时刻为T1N；Slave记录第一个SYNC消息达时刻T21，第N个SYNC的到达时刻为T2N；假设路径延时不变，那么：
主从时钟频率的比例因子＝（ T2N － T21）/ （ T1N －T11）
	根据比例因子可以调整从时钟与主时钟的频率同步。
      说明：如果路径延时不是恒定的，需要考虑第1个SYNC和第N个SYNC延时之间的差异。
 	根据设备的类型，平均路径延迟的测量可以通过如下方式实现：
	延迟请求响应机制：
	对于支持延迟请求响应机制的E2E TC，OC，BC的端口，可以采用Sync、Delay_Req、 Delay_resp和可选的 Follow_Up消息实现时间戳信息的传递，进行主从端口之间的路径延迟测量。



	Pdelay机制:
对于支持Pdelay机制的P2P TC，OC，BC的端口，采用Pdelay_Req，Pdelay_Resp和可选的 Pdelay_Resp_Follow_Up消息传递时间戳，完成对等端口之间的路径延迟测量


  














P2P设备模型0C

 

 	E2E TC中的驻留时间误差：
	用来计算驻留时间的时戳是根据本地时钟产生的。master和本地时钟之间的频率可能相差0.02%，由此引起的驻留时间测量误差也可能达到0.02%。例如驻留时间是1ms，引入的误差将达200ns，这么大的误差是无法接受的。

解决方案1：让本地时钟的频率跟踪主时钟
实现：设计RC（频率控制）模块，根据主时钟的时间戳序列和相应的本地时间戳来估计主时钟与本地时钟频率的比率。利用估计出来的频率比值来调整（即控制）本地时钟的频率。

解决方案2：采用本地自由振荡的时钟。
实现：设计RE（频率估计）模块，计算本地自振时钟和grandmater时钟之间的频率比率，用于修正Delay_Req， Pdelay_Req消息中的驻留时间。并计算修正过和没有修正过的驻留时间的差值，通过Sync或Follow_Up，Pdelay_Resp消息中自定义的TLV，将差值传递到从时钟，供从时钟计算slave和grandmaster之间的偏移。
	说明：在对等延时测量中，Pdelay_Resp消息像Sync消息那样处理，Pdelay_Req消息也完全像Delay_Req消息一样


 
 	P2P TC中链路延时(meanPathDelay)和驻留时间的修正：
	对于ONE-STEP P2P TC设备，将链路延时累积到sync消息里的correctionField字段中，在TC的出端口，将TC的驻留时间加入到Sync消息的correctionField中。
	对于TWO-STEP P2P TC设备，将链路延时累积到sync消息关联的Follow_Up消息里的correctionField字段中，在TC的出端口，将TC的驻留时间加入到Follow_Up消息的correctionField中。
	说明1：P2P TC 设备中的链路延时<meanPathDelay>是Pdelay机制测量连接到接收Sync消息端口链路的延时。
	说明2：P2P TC 设备中由于本地时钟频率差异引起的驻留时间误差通过E2E设备中相同的机制减小。
 	P2P TC设备中的路径延迟误差：
	如果Pdelay 测量采用本地自由振荡的时钟来完成，则在链路延时中有一个误差，这个误差等于Pdelay_Req消息的接收时间和Pdelay_Resp消息的发送时间之差，即t3-t2，再乘以TC时钟设备和相邻时钟设备之间的小数频偏。
	解决方案：设计一个RE2（邻居频率比值估计）模块，本地时钟通过测量连续的Pdelay_Resp以及Pdelay_Resp_Follow_Up消息中包含的时间戳信息得到TC时钟设备和相邻时钟设备之间的频偏。为了进行这个测量，必须分别传送Pdelay_Req接收时间（t2）和Pdelay_Resp发送时间（t3)。

	P2P和E2E TC的差别
	P2P TC时钟设备在每个端口通过Pdelay机制测量该端口和相邻节点端口之间的链路延时 。
	E2E TC修正并转发所有PTP定时消息，这些消息中相应的correctionField根据下列数值予以更新：Sync消息在P2P TC内的驻留时间以及接收Sync消息的端口上的链路延时。
	通过P2P TC组成的网络，最终提供给从时钟的定时信息，总是反映了网络的实际路径信息。而使用E2E方式修正延时，从时钟会等待基于Sync、Delay_Resp消息组合给出的新路径延时数值，这样会花费更多的时间。
	使用Pdelay机制测量路径延时，这种方式与基于延时请求-响应机制的路径延时测量方式不能互通。同样的，E2E TC设备也只支持延时请求-响应机制，不支持Pdelay机制。如果一个网络在某个区域中有P2P TC设备，而在另外一个区域有E2E TC设备，这两个区域只能通过BC连接。
	数据集定义
	数据集数据用于PTP协议引擎中的“状态决策算法”和PTP消息字段取值，相当于一些标准中定义的状态机常量和变量。
	OC和BC时钟数据集
	defaultDS：
	描述OC/BC的固有属性，如时钟标识，时钟质量，是否slave-only等；
	currentDS：
	描述同步相关属性，如主从时钟之间的时间偏差（offsetFromMaster）和传输延时（meanPathDelay）等；
	parentDS ：
	描述上级时钟设备（用于同步OC/BC的时钟）和grandmaster时钟设备（主从体系中的根时钟设备）的属性 ，如父时钟的portIdentity、稳定度和相位变化率属性等，grandmaster时钟的clockIdentity和时钟质量属性等；
	timePropertiesDS：
	描述时间标尺属性，如时标是否TAI时标，TAI和UTC的偏差，时标是否跟踪主参考时钟等。
	OC和BC端口数据集
	portDS：
	描述端口PTP协议属性，如PTP状态机状态值，延时测量机制，消息平均间隔等；
	foreignMasterDS：
	用于Announce消息的认证，包括配置时间窗内收到的外部主时钟Announce消息数量等。
	透明时钟(TC)数据集
	transparentClockDefaultDS
	包括clockIdentity，端口数量，延时机制等；
	transparentClockPortDS  
	包括portIdentity，PdelayReq消息平均间隔，对等传播延时等。



 	PTP消息分类
	Event报文:定时消息，发送和接收事件消息时要生成准确的时间戳
	Sync
	Delay_Req
	Pdelay_Req
	Pdelay_Resp
	General报文:不要求生成准确的时戳
	Announce
	Follow_Up
	Delay_Resp
	Pdelay_Resp_Follow_Up
	Management（专门有章节介绍，不在PTP章节体现）
	Signaling
 	PTP消息作用
	Sync, Delay_Req, Follow_Up和Delay_Resp报文用于产生和通信用于同步普通时钟和边界时钟的时间信息。
	Pdelay_Req, Pdelay_Resp和Pdelay_Resp_Follow_Up用于测量两个时钟port之间的链接延时。
	Annouce报文用于建立同步分层结构。
	Management报文用于查询和更新时钟所维护的PTP数据集。
	Signaling报文用于其他的目的，例如在Mater-Slave之间协调单播报文的发送频率。

 	所有PTP消息都由报头(header)，主体(body)，后缀(suffix)组成
	报头：通用报头，固定34字节，放在10个PTP消息的最前端。
	主体：PTP的10个消息通过主体里面的内容不同来区别。
	后缀：可以在这个域添加0或多个TLV，对PTP协议功能进行扩展。可添加的TLV类型参见“TLV实体定义 ”

4      延时补偿
4.1      秒帧头延时补偿
业务板利用主控下发的秒帧头来同步主控的时间，而帧头FP会经过主控逻辑背板以及业务板逻辑，硬件链路上会使帧头产生延时（delay1,delay2,delay3,delay4,delay5）。业务板需要讲帧头在物理链路上的延时补偿掉以便达到业务板的帧头与主控板产生的帧头在相位上对齐。否则1588时间在业务板的出口侧与时钟板的时间有固定偏差。延时补偿最大的意义在于将主控的秒帧头与业务板的秒帧头对齐。
时钟板SA8009会输出一个秒帧头，业务板也会输出一个补偿后的秒帧头。Top_rtc中有一个信号Probe_s，需要输出到管脚。方便硬件测量。
时钟板的管脚GPIO ，需要配置SA8006的两个寄存器，相应的把GPIO配置成输出，然后配置成1PPS输出即可。
配置8006的命令
:cfg-get-chipreg:$bid, 4, 0x26d,0x1
:cfg-get-chipreg:$bid, 4, 0x603,0x1
1800的秒帧头延时补偿寄存器，cib_timestamp
配置秒帧头的格式为2K模式，否则会一直上报秒帧头告警 tsp_err , bit[1]。
补偿单位是ns。由于9800是通过SMI传递的时间，一个SMI帧周期是6.17us，所以跟1800相比，秒帧头补偿的值较大，会超过255ns。
#LD8110的tmp3on20p单板配置的最终值是：
cfg-set-chipreg:$bid,$chipid,0x15cc4d,0x24
cfg-set-chipreg:$bid,$chipid,0x15cc4e,0x5b9b
     通常硬件需要测量不同网元，不同主控到业务板的秒帧头延时补偿。另外要说明的是：秒帧头延时补偿在同样的主控，同样的业务板测试上下游是抵消的，因此不会体现出来。而实际要做到的是将本网元的业务板要补偿进去，对接不同的系统才能最终不引入误差。
在上游补和下游补偿在仪表上显示会是相反的方向。在上游补，是补的T1和T4，在下游补是补得t2和t3。因此在符号上显示是反的。但是补偿的值是全部生效的，即补多少ns显示多少ns的偏移。
offset=[(t2 – (t1+ t1_CF)) – (t4 – ( t3+ t3_CF))]/2
4.2      Delay_req非对称延时补偿
1588V2中的时间同步是以双向链路时延对称为前提的，如果不对称，在计算offset的过程中就会引入偏差。而在实际应用的过程中，收发光纤长度不对称不可避免，所以设备加了一个专门针对不对称设置补偿值的功能。
delay_req报文的不对称修正：
对于BC和OC时钟，在出口传输Delay_Req消息之前要对其进行修改。也就是Delay_Req消息的correctionField减去一个出口通道的delayAsymmtry。DelayAsymmetry是在收端进行的补偿。非对称补偿是补码形式，所以可以正向和负向补偿。ptp1588_cbb模块和ptp1588_adapt模块均具有delay_req报文补偿非对称延时的功能。
Ptp1588_cbb中的非对称补偿地址：cib_1588_cbb+0x2005  
在补偿时，也可以用软件命令，软件命令可以直接补数值，也可以按长度补。长度和时间的换算关系是，1m光纤是4.83ns延时。
cfg-set-ptplinewarp:$bid,0xff,$port,length,negative,0
cfg-set-ptplinewarp:$bid,0xff,$port,length,positive,0
cfg-set-ptplinewarp:$bid,0xff,$port,time,positive,0
按照仪表上差的补偿值直接补，发现直接配置补偿值，即可以完全补偿回来。
发端补偿值生效一半，收端补偿值全部生效的原因：
发端补偿用的是cib_1588_adatp寄存器。由于发端补偿仅仅补偿的t1是戳，根据公式，offset=[(t2 – t1) – (t4 – t3)]/2可知，我们补偿的时候，补偿在t1上的时间，offset显示在仪表上的会除以2，即指生效一半。
收端补偿，逻辑内部有两个地方均可以做补偿，一个是1588_cbb， 一个是cib_1588_adapt，在测试中发现，当配置补偿时间时，软件实际上会同时配置这两个地方。
故当两个一起配置时，就全部生效了。
寄存器：
#查询tmb1ast2单板的cib_1588_adapt:
:cfg-get-chipreg:$bid,3,0x1812,0x10
#查询1588 cbb中的asymmetry， 只看后24bit。
:optp:$bid,1,83,1,f2,02,$Read1588CBB,$hport,20,05;
关于长度的补偿：如果长度为20m， offset= 20*4.83/2= 48ns, 仪表显示是48ns。 用长度补也是补的48ns，只是会同时补到cbb和adapt模块，所以实际补的还是48ns。用时间值补也是48ns，就是作为从设备具体是多少ns就补多少ns。
4.3      发端延时补偿
发端延时补偿功能是19H2新增的特性。原因是：ASTX单板存在盲区光纤，OTDR的原理，光纤检测时近端光纤(仪表与光纤连接口)有盲区(事件盲区和衰减盲区)，加这段盲区光纤后，可以更精准的光纤链路中的事件点和故障点。ASTX的单板的盲区光纤长度有150m和110m之分。因此存在双方单板所用的盲区光纤长度不等长，引入固定偏移，需要对此进行补偿。
方案：在发端补偿，补偿具有正负补偿的能力，支持16bitns补偿范围。基数按照150米盲区光纤补偿。
在实际补偿中，1D1U单板实际上盲区光纤长度是110m，但实际上1D1U的发送端口和接收端口都有110m的盲区光纤，在和TMB1AST2对接时，TMB1AST2只有单个方向有150m的盲区光纤，因此实际差值是150m。在补偿时，按照150m的差值补偿在发端。150*4.83=724.5ns。在仪表上显示的362ns的固定偏差。
发端补偿寄存器配置的值会生效一半，原因仍然是因为根据公式，offset=[(t2 – t1) – (t4 – t3)]/2，在发端补偿，仅仅补偿的t1值。且在上游和下游补偿，方向刚好相反。
发端补偿寄存器：cib_1588_adapt：0x41，符号 0x51~0x57 补偿值。
5      普通精度1588和高精度1588
5.1      普通精度和高精度的背板区别
普通精度的时戳是：48bit s + 32bit ns。高精度的时戳是有多个域。TOD和npps_sci，mpps_cci，其中mpps_cci是表征频率的CI信息，业务板卡单片8009场景用不到。逻辑不需要对mpps_cci做处理。并且目前单片SA8009就只用一个域，即下面数据结构中的第一行。Tod时戳和npps_sci是两个时钟域，SA8009打的时戳还需要做线性差值，即将common域的时戳插值到rte时钟域。
线性差值的原理：
已知两个RTC间的线性关系，和tp时刻在RTC_0上的时戳信息，即可通过线性关系推算出tp时刻在RTC_1上的时戳信息。
如下图：已知tp发生在[t1,t2]之间，且在t1和t2[t1,t2]之间CMNRTC与RTE间的fofst不变，即可通过t1,t2时刻cmnrtc与rte的值，以及tp时刻CMNRTC计数值，推算出tp时刻RTE的计数值。
在9800的平台，SMI接口传的高精度时戳的时隙位置和普通精度的有区别，两者不共用，不会相互干扰。
老数据格式占ts8的复帧1~12(含16bitCRC)，新数据格式占ts8复帧25~40,58~63。高精度上送8K，普通精度上送1K鉴相值。
5.2      普通精度和高精度的打戳区别
   普通精度是内部的RTC打戳，高精度是业务板内的SA8009打戳，时戳精度多16bit小数ns。
   高精度是主控板的高精度时戳通过管理SMI接口下发到FPGA，FPGA提取出所需的SCI和TOD等信息转换成和SA8009的SMI接口格式。SA8009实现同步主控时间。CPLD直接把秒帧头给SA8009，秒帧头延时在SA8009补偿。SA8009会对输入的帧头和时间再次打戳，来记录8009的时间和主控8009时间的差值，来调整时间和主控一致。
高精度是FPGA将TX_FP/RX_FP帧头传递给SA8009，SA8009将时戳回传给FPGA芯片，做了线性插值后用于报文打戳。



