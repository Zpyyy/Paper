 	网络IP化引发分组网络时钟同步问题
	IP化是未来网络和业务的发展趋势，但是以SDH为基础的传统网络过渡到以IP为基础的分组传送网络目前还存在很多困难，一个关键技术是解决新网络对传统TDM业务的承载。传统TDM有两个主要的应用，语音业务和时钟同步业务。对于语音，VoIP化后，在IP网络上承载的技术已经成熟并且大规模应用，但是对于时钟同步业务相关的各种技术还在发展中,于是分组时钟技术开始崭露头角。
 	业界提出了几种实现分组网络(PSN)同步的技术方案
	TOP（Timing Over Packet-switching network）
	以太网物理层同步
	IEEE1588V1/ IEEE 1588V2
	NTP


 	什么是1588？
	IEEE 1588是网络测量和控制系统的精密时钟同步协议标准，采用PTP（精密时钟同步）协议，精度可以达到微秒级。此标准的目的是为了精确地把测量与控制系统中分散、独立运行的时钟同步起来。
 	1588有何优势？
同步技术	频率同步	时间同步	相关标准
TOP	√	×	ITU-T G.8261
以太网物理层同步	√	×	ITU-T G.8262
1588	√	√	IEEE 1588v2
NTP	√	√	RFC 1305 



 	【术语解释】 什么是同步 ?  指两个或两个以上信号之间，在频率或相位上保持某种特定关系，即两个或两个以上信号在相对应的有效瞬间，其相位差或频率差保持在约定的允许范围之内，由同步的定义可知，同步包括以下两种：频率同步和时间同步（相位同步）。目前的3G协议如TD-SCDMA等对于时间同步都有明确的要求。
 	其它同步技术有何特点和优势？
同步技术	技术特点	优势	局限
TOP	•	将本地时钟（timing）信息根据一定的封装格式放入数据包（packet）中发送，在接收端从包中恢复时钟，通过算法和封装格式尽量规避PSN传送过程中所带来的损伤	•	支持PSN网络透传，不要求中间设备支持TOP，运用灵活
•	厂商芯片支持较好，我司也有相关技术开发，实现技术较成熟	•	恢复时钟的质量依赖于承载的PSN网络，受网络延迟抖动、丢包、错序的影响非常大，需要保证业务高QoS
•	 没有标准化协议，不同设备间兼容性差
•	 不支持时间同步
以太网物理层同步	•	利用以太网物理层同步技术，最后达到包网络的全面同步	•	时钟同步质量接近SDH
•	不受PSN网络影响
•	系统时钟架构与SDH方案相似，实现技术较成熟	•	需要全网部署
•	不是所有的以太接口都可以恢复时钟
•	不支持时间同步
NTP	•	NTP（网络时间协议），时钟定时方式类似与1588，广泛用于Internet网络定时	•	可以同时实现频率与时间同步	•	时钟精度为ms级，不能满足3G电信网络的要求
1588v2	•	PTP（精确时钟同步协议），利用协议报文传递同步信息，可应用于电信、测量和工业控制领域的同步	•	可以实现时间同步
•	时钟精度为亚us级，应用范围广
•	协议自动协商、无需配置	•	要求全网设备支持，必须全网部署
•	新技术，要求硬件支持，协议较复杂，部署成本较高

 	IEEE1588的前世今生
	以太网在1985年成为IEEE802.3标准后，在1995年将数据传输速度从10Mb/s提高到100Mb/s的过程中，计算机和网络业界也在致力于解决以太网的定时同步能力不足的问题，开发出一种软件方式的网络时间协议（NTP），提高各网络设备之间的定时同步能力，但是仍然不能满足测量仪器和工业控制所需的准确度 ；
	为解决上述问题，2000年底成立网络精密时钟同步委员会，2001年中获得IEEE仪器和测量委员会美国标准技术研究所（NIST）的支持，该委员会起草的规范在2002年底获得IEEE标准委员会通过作为IEEE1588标准；
	在通讯领域中，PSN网络传时钟的技术迅速发展，IEEE组织对1588进行了重新修订，最新版本在2006.6月份输出，2007年完成V2修订。
 	IEEE1588 V2的新增特性
	亚us级的准确度；
	更快的同步（SYNC）信息速率 ；
	更短的PTP信息，单播信息，新的信息(路径延迟需求/响应/相应follow-up)和信息字段；
	引入透明时钟（TC）可以用来防止级联拓扑中的误差累计；
	故障容限，它用来保证不会因为某单一网络单元失效引起对端时钟也故障 ；
	TLV扩展用来延伸协议特性和功能；
	将1588映射到其他传输机制。
 	时间同步(Synchronization):
	相同的频率
 	时钟2与时钟1的频率相同
	相同的相位
 	时钟2与时钟1的相位相同
	相同的时间(time of day)
 	时间跟踪至一个公共的、统一的时标，如UTC、TAI等


 	时钟同步(Syntonization)：
	相同的频率
 	时钟2与时钟1的频率相同
	不同的相位
 	时钟2与时钟1的相位可能不同
	不同的时间(time of day)
 	时间可能不同 
标准时间源 
第一个时间源是实现NTP协议的一套广泛运用于校园和全世界的计算机系统。这些NTP服务器自身同步到国际标准时间服务器。从NTP系统获得的UTC时间精度通常在毫秒范围。NTP提供当前时间、当前闰秒数(仅在NTP版本4支持)，以及标识引入闰秒修正的告警标志。NTP系统的时间起点为1900年1月1日0时。
第二个系统是由美国国防部维护的全球卫星定位系统(GPS)。从GPS系统获取到的时间精度在10～100纳秒范围内。GPS系统传输时间的形式为{GPS星期数，最近一周的GPS秒数}，也就是从GPS起点开始的周数以及从当前周开始的秒数。GPS提供当前时间，当前闰秒数目，以及引入闰秒校修正的告警标志。GPS系统的时间起点为1980年1月6日0时。

 	PTP时标起点
	起点是一个域的时标的起点。
	PTP起点是TAI时间的1970年1月1日0时0分0秒，UTC时间的1969年12月31日23时59分51.999918秒
	PTP支持两种类型的时标：
	PTP时标：在正常运行情况中，起点是PTP时标起点，并且时标是连续的。时间度量单位是SI秒。
	独立时标：正常运行情况下起点通过管理进程设置。在正常运行期间允许复位起点。在两个管理进程的调用之间，时标是连续的。额外的调用管理进程的干预可能引起整个时标不连续。

 	共有五种基本的PTP设备类型：
	OC(Ordinary clock)：仅有一个物理接口同网络通信，既可作为Grandmaster Clock，也可作为Slave Clock。 
	BC(Boundary clock)：有多个物理接口同网络通信，每个物理端口行为都类似于Ordinary Clock的端口，可连接多个子域。 
	E2E TC(End-to-end transparent clock)：E2E TC设备有多个接口，它转发所有PTP消息，并测量PTP事件消息经过该设备的驻留时间，并进行修正。 
	P2P TC(Peer-to-peer transparent clock)：P2P TC设备有多个接口，与E2E TC设备相比，它还可以测量该设备每个端口相连链路的延迟 ，并进行修正。
	PTP管理设备：该设备具有多个接口，提供PTP管理消息的管理接口















 	同步过程概述：
	主从层次确定：通过“BMC算法”和“PTP端口状态机”确定OC和BC设备每个端口的主从状态，划分同步网络的主从层次。
     说明：TC设备不参与层次的确定
	时钟信息同步：在PTP系统中，OC或BC时钟设备同步通过在它们之间的物理链路上交换PTP消息，计算出主从时间偏移和链路延时，完成同步。

 

 	主从层次确定：
	根据OC和BC设备上端口所处的状态，可以对MESH网络进行裁剪，确定主从层次，消除PTP网络的环回：


































时钟信息同步：
	主从时钟时间的同步：Master记录SYNC消息记录出发时刻T1；Slave记录SYNC消息达时刻T2；路径延时为td。那么主从时钟之间的时间偏差为：
	offsetFromMaster ＝ T2－td－T1
	从时钟向前调整offsetFromMaster就实现主从时钟之间的同步。
	主从时钟频率信息的同步：Master记录第1个SYNC的发送时刻为T11，第N个SYNC的发送时刻为T1N；Slave记录第一个SYNC消息达时刻T21，第N个SYNC的到达时刻为T2N；假设路径延时不变，那么：
主从时钟频率的比例因子＝（ T2N － T21）/ （ T1N －T11）
	根据比例因子可以调整从时钟与主时钟的频率同步。
      说明：如果路径延时不是恒定的，需要考虑第1个SYNC和第N个SYNC延时之间的差异。
 	根据设备的类型，平均路径延迟的测量可以通过如下方式实现：
	延迟请求响应机制：
	对于支持延迟请求响应机制的E2E TC，OC，BC的端口，可以采用Sync、Delay_Req、 Delay_resp和可选的 Follow_Up消息实现时间戳信息的传递，进行主从端口之间的路径延迟测量。



	Pdelay机制:
对于支持Pdelay机制的P2P TC，OC，BC的端口，采用Pdelay_Req，Pdelay_Resp和可选的 Pdelay_Resp_Follow_Up消息传递时间戳，完成对等端口之间的路径延迟测量


  














P2P设备模型0C

 

 	E2E TC中的驻留时间误差：
	用来计算驻留时间的时戳是根据本地时钟产生的。master和本地时钟之间的频率可能相差0.02%，由此引起的驻留时间测量误差也可能达到0.02%。例如驻留时间是1ms，引入的误差将达200ns，这么大的误差是无法接受的。

解决方案1：让本地时钟的频率跟踪主时钟
实现：设计RC（频率控制）模块，根据主时钟的时间戳序列和相应的本地时间戳来估计主时钟与本地时钟频率的比率。利用估计出来的频率比值来调整（即控制）本地时钟的频率。

解决方案2：采用本地自由振荡的时钟。
实现：设计RE（频率估计）模块，计算本地自振时钟和grandmater时钟之间的频率比率，用于修正Delay_Req， Pdelay_Req消息中的驻留时间。并计算修正过和没有修正过的驻留时间的差值，通过Sync或Follow_Up，Pdelay_Resp消息中自定义的TLV，将差值传递到从时钟，供从时钟计算slave和grandmaster之间的偏移。
	说明：在对等延时测量中，Pdelay_Resp消息像Sync消息那样处理，Pdelay_Req消息也完全像Delay_Req消息一样


 
 	P2P TC中链路延时(meanPathDelay)和驻留时间的修正：
	对于ONE-STEP P2P TC设备，将链路延时累积到sync消息里的correctionField字段中，在TC的出端口，将TC的驻留时间加入到Sync消息的correctionField中。
	对于TWO-STEP P2P TC设备，将链路延时累积到sync消息关联的Follow_Up消息里的correctionField字段中，在TC的出端口，将TC的驻留时间加入到Follow_Up消息的correctionField中。
	说明1：P2P TC 设备中的链路延时<meanPathDelay>是Pdelay机制测量连接到接收Sync消息端口链路的延时。
	说明2：P2P TC 设备中由于本地时钟频率差异引起的驻留时间误差通过E2E设备中相同的机制减小。
 	P2P TC设备中的路径延迟误差：
	如果Pdelay 测量采用本地自由振荡的时钟来完成，则在链路延时中有一个误差，这个误差等于Pdelay_Req消息的接收时间和Pdelay_Resp消息的发送时间之差，即t3-t2，再乘以TC时钟设备和相邻时钟设备之间的小数频偏。
	解决方案：设计一个RE2（邻居频率比值估计）模块，本地时钟通过测量连续的Pdelay_Resp以及Pdelay_Resp_Follow_Up消息中包含的时间戳信息得到TC时钟设备和相邻时钟设备之间的频偏。为了进行这个测量，必须分别传送Pdelay_Req接收时间（t2）和Pdelay_Resp发送时间（t3)。

	P2P和E2E TC的差别
	P2P TC时钟设备在每个端口通过Pdelay机制测量该端口和相邻节点端口之间的链路延时 。
	E2E TC修正并转发所有PTP定时消息，这些消息中相应的correctionField根据下列数值予以更新：Sync消息在P2P TC内的驻留时间以及接收Sync消息的端口上的链路延时。
	通过P2P TC组成的网络，最终提供给从时钟的定时信息，总是反映了网络的实际路径信息。而使用E2E方式修正延时，从时钟会等待基于Sync、Delay_Resp消息组合给出的新路径延时数值，这样会花费更多的时间。
	使用Pdelay机制测量路径延时，这种方式与基于延时请求-响应机制的路径延时测量方式不能互通。同样的，E2E TC设备也只支持延时请求-响应机制，不支持Pdelay机制。如果一个网络在某个区域中有P2P TC设备，而在另外一个区域有E2E TC设备，这两个区域只能通过BC连接。
	数据集定义
	数据集数据用于PTP协议引擎中的“状态决策算法”和PTP消息字段取值，相当于一些标准中定义的状态机常量和变量。
	OC和BC时钟数据集
	defaultDS：
	描述OC/BC的固有属性，如时钟标识，时钟质量，是否slave-only等；
	currentDS：
	描述同步相关属性，如主从时钟之间的时间偏差（offsetFromMaster）和传输延时（meanPathDelay）等；
	parentDS ：
	描述上级时钟设备（用于同步OC/BC的时钟）和grandmaster时钟设备（主从体系中的根时钟设备）的属性 ，如父时钟的portIdentity、稳定度和相位变化率属性等，grandmaster时钟的clockIdentity和时钟质量属性等；
	timePropertiesDS：
	描述时间标尺属性，如时标是否TAI时标，TAI和UTC的偏差，时标是否跟踪主参考时钟等。
	OC和BC端口数据集
	portDS：
	描述端口PTP协议属性，如PTP状态机状态值，延时测量机制，消息平均间隔等；
	foreignMasterDS：
	用于Announce消息的认证，包括配置时间窗内收到的外部主时钟Announce消息数量等。
	透明时钟(TC)数据集
	transparentClockDefaultDS
	包括clockIdentity，端口数量，延时机制等；
	transparentClockPortDS  
	包括portIdentity，PdelayReq消息平均间隔，对等传播延时等。



 	PTP消息分类
	Event报文:定时消息，发送和接收事件消息时要生成准确的时间戳
	Sync
	Delay_Req
	Pdelay_Req
	Pdelay_Resp
	General报文:不要求生成准确的时戳
	Announce
	Follow_Up
	Delay_Resp
	Pdelay_Resp_Follow_Up
	Management（专门有章节介绍，不在PTP章节体现）
	Signaling
 	PTP消息作用
	Sync, Delay_Req, Follow_Up和Delay_Resp报文用于产生和通信用于同步普通时钟和边界时钟的时间信息。
	Pdelay_Req, Pdelay_Resp和Pdelay_Resp_Follow_Up用于测量两个时钟port之间的链接延时。
	Annouce报文用于建立同步分层结构。
	Management报文用于查询和更新时钟所维护的PTP数据集。
	Signaling报文用于其他的目的，例如在Mater-Slave之间协调单播报文的发送频率。

 	所有PTP消息都由报头(header)，主体(body)，后缀(suffix)组成
	报头：通用报头，固定34字节，放在10个PTP消息的最前端。
	主体：PTP的10个消息通过主体里面的内容不同来区别。
	后缀：可以在这个域添加0或多个TLV，对PTP协议功能进行扩展。可添加的TLV类型参见“TLV实体定义 ”
